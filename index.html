<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miga Mining App - Real Data</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0066cc;
      --secondary: #004d99;
      --accent: #ff9900;
      --dark: #001a33;
      --light: #f0f7ff;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --bronze: #cd7f32;
      --silver: #c0c0c0;
      --gold: #ffd700;
      --platinum: #e5e4e2;
      --diamond: #b9f2ff;
      --pulse: 0 0 15px rgba(0, 200, 255, 0.7);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #001a33, #003366);
      color: var(--light);
      min-height: 100vh;
      padding: 15px 0 80px;
      text-align: center;
      font-size: 16px;
      overflow-x: hidden;
    }
    
    /* Tab Content Styles */
    .tab-content {
      display: none;
      padding: 10px;
      animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Home Page Styles */
    .home-container {
      max-width: 480px;
      margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px auto;
      max-width: 450px;
      padding: 0 10px;
    }

    .stat-card-large {
      background: rgba(0, 40, 80, 0.5);
      border-radius: 12px;
      padding: 20px 15px;
      text-align: center;
      transition: transform 0.3s ease;
      border: 1px solid rgba(0, 102, 204, 0.2);
    }

    .stat-card-large:hover {
      transform: translateY(-5px);
      background: rgba(0, 51, 102, 0.7);
    }

    .stat-value-large {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      margin: 10px 0;
    }

    .stat-label-large {
      font-size: 14px;
      color: #aee9f7;
      font-weight: 500;
    }

    .chart-section {
      max-width: 450px;
      margin: 10px auto 0;
      padding: 0 10px;
    }

    .chart-note {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 5px;
    }

    .current-price {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--accent);
    }

    canvas {
      background-color: rgba(0, 40, 80, 0.2);
      border-radius: 10px;
      padding: 6px;
      box-shadow: 0 0 10px rgba(182, 79, 200, 0.3);
      width: 100% !important;
      height: 140px !important;
      display: block;
      margin: auto;
    }

    .info-box {
      background-color: rgba(0, 40, 80, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin: 20px auto;
      max-width: 450px;
      color: #ffffff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      font-size: 14px;
      line-height: 1.6;
    }
    
    .info-box strong {
      color: var(--accent);
    }

    /* Friends Page Styles */
    .friends-container {
      max-width: 480px;
      margin: 0 auto;
    }
    
    .invite-container {
      background-color: rgba(0, 40, 80, 0.5);
      border-radius: 10px;
      padding: 20px;
      margin: 0 auto 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    }

    .invite-title {
      font-weight: bold;
      font-size: 22px;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .invite-subtitle {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .invite-description {
      font-size: 14px;
      margin-bottom: 15px;
      color: #aee9f7;
    }

    .invite-link-box {
      background-color: rgba(0, 51, 102, 0.8);
      border-radius: 8px;
      padding: 12px 15px;
      margin: 0 auto 10px;
      word-break: break-all;
      font-size: 16px;
      cursor: pointer;
      user-select: all;
      box-shadow: 0 0 8px rgba(182, 79, 200, 0.5);
      max-width: 100%;
      transition: all 0.3s ease;
    }
    
    .invite-link-box:hover {
      background-color: rgba(0, 70, 140, 0.8);
    }

    .copy-message {
      margin-top: 10px;
      font-size: 14px;
      color: var(--success);
      height: 18px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .copy-message.visible {
      opacity: 1;
    }

    .friends-count {
      margin-top: 15px;
      font-size: 15px;
      color: #aee9f7;
      font-weight: 600;
    }

    /* Referrals table */
    .referrals-table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      font-size: 14px;
      background: rgba(0,51,102,0.3);
      color: #cce7ff;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .referrals-table th, .referrals-table td {
      padding: 8px 5px;
      border: 1px solid #235;
    }
    
    .referrals-table th {
      background: rgba(0,51,102,0.7);
      color: #ff9900;
    }
    
    .referrals-table tfoot td {
      background: rgba(0,51,102,0.6);
      font-weight: bold;
      color: #ffd700;
    }
    
    .referrals-table td {
      background: rgba(0,51,102,0.3);
    }
    
    .referrals-table .center {
      text-align: center;
    }
    
    .loading-indicator {
      font-size: 14px;
      color: var(--accent);
      margin-top: 10px;
      font-weight: 600;
      padding: 10px;
    }

    /* Mining Page Styles - UPDATED TO MATCH ORIGINAL */
    .mining-container {
      max-width: 480px;
      margin: 0 auto;
    }
    
    .plan-title {
      font-weight: bold;
      font-size: 20px;
      margin: 15px 0;
      color: var(--accent);
    }
    
    .wallet-message, .plan-message, .alert-message {
      display: none;
      position: fixed; 
      bottom: 80px; 
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      color: var(--danger);
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      z-index: 1000;
      font-size: 14px;
      animation: fadeInOut 3s ease-in-out;
    }
    
    .alert-message {
      top: 20%;
      bottom: auto;
      padding: 15px 25px;
      border-radius: 15px;
      font-size: 16px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      max-width: 85%;
    }
    
    #ton-connect {
      margin: 15px auto;
      display: flex;
      justify-content: center;
    }
    
    .points-display {
      margin: 15px 0;
      font-size: 16px;
      background: rgba(0, 40, 80, 0.5);
      padding: 10px 20px;
      border-radius: 25px;
      display: inline-block;
    }
    
    .points-display span { 
      font-weight: bold; 
      color: var(--accent);
    }  
    
    .circle-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 15px;
      max-width: 100%;
      margin: 0 auto;
    }
    
    .plan-row, .centered-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      width: 100%;
    }  
    
    #free-claim {
      margin-top: 25px;
      white-space: nowrap;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
    }
    
    #free-claim .miga-points,
    #free-claim .days-title {
      display: inline;
      margin: 0 5px;
    }
    
    .plan-row { 
      justify-content: space-between; 
      max-width: 380px;  
    }
    
    .circle-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: transform 0.3s ease;
    }
    
    .circle-container:hover {
      transform: translateY(-5px);
    }
    
    .circle-card {
      width: 140px;
      height: 140px;
      background: linear-gradient(135deg, rgba(0, 51, 102, 0.8), rgba(0, 30, 60, 0.8));
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      padding: 10px;
      cursor: pointer;
      border: 1px solid rgba(0, 102, 204, 0.3);
      transition: all 0.3s ease;
      line-height: 1.3;
    }
    
    .circle-card:hover {
      transform: scale(1.05);
      box-shadow: var(--pulse);
    }
    
    .special {
      background: linear-gradient(135deg, rgba(182, 79, 200, 0.8), rgba(122, 40, 168, 0.8));
    }
    
    .badge {
      position: absolute; 
      top: -23px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      min-width: 70px;
      text-align: center;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }
    
    .bronze-badge {
      background: var(--bronze);
      color: #fff;
      border: 1px solid #a65a2a;
    }
    
    .silver-badge {
      background: var(--silver);
      color: #333;
      border: 1px solid #a0a0a0;
    }
    
    .gold-badge {
      background: var(--gold);
      color: #333;
      border: 1px solid #d4af37;
    }
    
    .platinum-badge {
      background: var(--platinum);
      color: #333;
      border: 1px solid #c0c0c0;
    }
    
    .diamond-badge {
      background: var(--diamond);
      color: #333;
      border: 1px solid #a3dae9;
    }
    
    .miga-points {
      font-size: 16px;
      font-weight: bold;
      color: var(--accent);
      margin: 5px 0;
    }
    
    .days-title {
      font-size: 12px;
      font-weight: bold;
    }
    
    .ton-amount {
      font-size: 11px;
      color: #ddd;
      margin: 3px 0;
    }
    
    .countdown-timer {
      font-size: 11px; 
      font-weight: 600;
      color: var(--accent);
      margin-top: 5px;
      height: 15px;
      display: none;
    }
    
    .active-pulse {
      animation: pulse 2s infinite;
      box-shadow: var(--pulse);
    }
    
    .badge-pulse {
      animation: badgePulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    @keyframes badgePulse {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.1); }
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    @keyframes coinPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    #free-claim.collected {
      animation: pulse 0.8s 1;
    }
    
    .circle-card.free {
      width: 160px;
      height: 50px;
      border-radius: 30px;
      background: rgba(60, 60, 60, 0.6);
      cursor: not-allowed;
    }
    
    .circle-card.free.active {
      background: linear-gradient(to right, var(--success), #1e7e34);
      cursor: pointer;
    }
    
    .circle-card.free.active:hover {
      background: linear-gradient(to right, #1e7e34, var(--success));
      box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }
    
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 10px 0 20px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: rgba(0, 40, 80, 0.5);
      border-radius: 12px;
      padding: 10px 15px;
      min-width: 120px;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      background: rgba(0, 51, 102, 0.7);
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .stat-label {
      font-size: 12px;
      color: #aaa;
    }

    /* Tasks Page Styles */
    .tasks-container {
      max-width: 480px;
      margin: 20px auto;
      padding: 0 15px;
    }
    
    /* New Tasks Tab Styles */
    .task-tabs {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      gap: 5px;
    }
    
    .task-tab {
      flex: 1;
      background: rgba(0, 40, 80, 0.5);
      border: none;
      border-radius: 8px;
      padding: 10px 5px;
      color: #aee9f7;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .task-tab i {
      font-size: 18px;
      margin-bottom: 5px;
    }
    
    .task-tab:hover {
      background: rgba(0, 51, 102, 0.7);
      transform: translateY(-2px);
    }
    
    .task-tab.active {
      background: var(--accent);
      color: #001a33;
      font-weight: bold;
      box-shadow: 0 0 8px rgba(255, 153, 0, 0.5);
    }
    
    .task-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .task-content.active {
      display: block;
    }
    
    .task-category {
      margin-bottom: 25px;
    }
    
    .category-title {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--accent);
      padding-left: 5px;
      text-align: left;
    }
    
    .task-list {
      background-color: rgba(0, 40, 80, 0.5);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    }
    
    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 10px;
      border-bottom: 1px solid rgba(0, 51, 102, 0.8);
    }
    
    .task-item:last-child {
      border-bottom: none;
    }
    
    .task-info {
      flex: 1;
      padding-right: 10px;
    }
    
    .task-name {
      font-size: 14px;
      color: #ffffff;
      margin-bottom: 3px;
    }
    
    .task-description {
      font-size: 12px;
      color: #aee9f7;
    }
    
    .task-reward {
      font-size: 13px;
      color: var(--success);
      white-space: nowrap;
      margin-bottom: 5px;
    }
    
    .task-button {
      background-color: var(--accent);
      color: #001a33;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      min-width: 70px;
      transition: background-color 0.3s;
      font-weight: bold;
    }
    
    .task-button:hover {
      background-color: #ffaa00;
    }
    
    .task-button:disabled {
      background-color: #555;
      cursor: not-allowed;
      color: #aaa;
    }
    
    .progress-bar {
      height: 5px;
      background-color: rgba(0, 51, 102, 0.8);
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: var(--success);
      border-radius: 3px;
    }

    /* Leaders Page Styles */
    .leaders-container {
      max-width: 480px;
      margin: 20px auto;
      padding: 0 15px;
    }

    .leaderboard h2 {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #ffffff;
    }

    .leader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      background-color: rgba(0, 40, 80, 0.5);
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      font-size: 14px;
    }

    .rank {
      font-weight: bold;
      color: var(--accent);
      width: 30px;
    }

    .name {
      flex-grow: 1;
      padding: 0 10px;
      color: #ffffff;
    }

    .amount {
      font-weight: bold;
      color: var(--success);
      font-size: 14px;
      white-space: nowrap;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(10, 30, 50, 0.95);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-top: 1px solid rgba(0, 51, 102, 0.8);
      z-index: 999;
      backdrop-filter: blur(5px);
    }

    .nav-item {
      text-align: center;
      color: #aaa;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 5px 10px;
      flex: 1;
      max-width: 20%;
      transition: all 0.3s ease;
    }

    .nav-item i {
      font-size: 20px;
    }

    .nav-item.active {
      color: var(--accent);
      transform: translateY(-5px);
    }
    
    .nav-item.active i {
      animation: pulse 1.5s infinite;
    }

    .nav-item:hover {
      color: #fff;
    }
    
    /* User Profile */
    .profile-header {
      background: rgba(0, 40, 80, 0.5);
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 450px;
      text-align: center;
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background: linear-gradient(135deg, #0066cc, #b64fc8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
    }
    
    .profile-name {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--accent);
    }
    
    .profile-username {
      font-size: 14px;
      color: #aee9f7;
      margin-bottom: 15px;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 480px) {
      body {
        font-size: 15px;
        padding: 12px 0 75px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .plan-title {
        font-size: 18px;
      }
      
      .circle-card {
        width: 120px;
        height: 120px;
        font-size: 11px;
      }
      
      .badge {
        font-size: 11px;
        min-width: 65px;
        top: -21px;
      }
      
      .stat-card {
        min-width: 110px;
        padding: 8px 12px;
      }
      
      .nav-item i {
        font-size: 18px;
      }
      
      .task-tab {
        font-size: 12px;
        padding: 8px 3px;
      }
    }
    
    @media (max-width: 360px) {
      body {
        font-size: 14px;
      }
      
      .circle-card {
        width: 100px;
        height: 100px;
        font-size: 10px;
      }
      
      .badge {
        font-size: 10px;
        min-width: 60px;
        top: -19px;
      }
      
      .stat-card {
        min-width: 100px;
        padding: 7px 10px;
      }
      
      .nav-item i {
        font-size: 16px;
      }
      
      .task-tab {
        font-size: 11px;
        padding: 6px 2px;
      }
    }
  </style>
</head>
<body>
  <!-- Home Tab Content -->
  <div id="home-tab" class="tab-content">
    <div class="home-container">
      <!-- User Profile -->
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="profile-name" id="userName">Loading...</div>
        <div class="profile-username" id="userUsername">@username</div>
        <div class="points-display">
          Total Miga: <span id="userTotalMiga">0</span> Mg
        </div>
      </div>

      <!-- Global Stats -->
      <div class="stats-grid">
        <div class="stat-card-large">
          <div class="stat-label-large">Total Users</div>
          <div class="stat-value-large" id="totalUsers">0</div>
        </div>
        <div class="stat-card-large">
          <div class="stat-label-large">Total Miga Mined</div>
          <div class="stat-value-large" id="totalMigaMined">0</div>
        </div>
        <div class="stat-card-large">
          <div class="stat-label-large">Active Miners</div>
          <div class="stat-value-large" id="activeMiners">0</div>
        </div>
        <div class="stat-card-large">
          <div class="stat-label-large">Your Rank</div>
          <div class="stat-value-large" id="userRank">#0</div>
        </div>
      </div>

      <div class="chart-section">
        <div class="chart-note">Global Mining Progress (Last 7 Days)</div>
        <canvas id="miningChart" width="400" height="160"></canvas>
      </div>

      <div class="info-box">
        <strong>Real Mining Statistics</strong><br>
        All data shown is real and fetched from the blockchain database.<br><br>
        <strong>How Mining Works:</strong><br>
        1. Choose a mining plan based on duration and investment<br>
        2. Your mining speed depends on the plan multiplier<br>
        3. Earn Miga tokens continuously while your plan is active<br>
        4. Complete tasks and invite friends to earn bonus Miga<br><br>
        <strong>Total Supply:</strong> 25 Billion Miga Tokens
      </div>
    </div>
  </div>

  <!-- Friends Tab Content -->
  <div id="friends-tab" class="tab-content">
    <div class="friends-container">
      <div class="invite-container">
        <div class="invite-title">Invite Friends</div>
        <div class="invite-subtitle">Invite friends to join Miga Mining</div>
        <div class="invite-description">
          Earn 100 Miga for each friend you invite!
        </div>

        <div id="inviteLink" class="invite-link-box" title="Click to copy link">
          Loading invite link...
        </div>
        <div id="copyMsg" class="copy-message">Link copied!</div>

        <div id="friendsCount" class="friends-count">
          Friends invited: <strong>0</strong> | Earned: <strong id="referralEarnings">0</strong> Mg
        </div>
        <div id="loadingIndicator" class="loading-indicator" style="display:none;">
          <i class="fas fa-spinner fa-spin"></i> Loading friends data...
        </div>
        
        <!-- Referrals table -->
        <div style="overflow-x:auto;">
          <table class="referrals-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Username</th>
                <th>Join Date</th>
                <th>Status</th>
                <th>Reward</th>
              </tr>
            </thead>
            <tbody id="referralsBody">
              <tr><td colspan="5" style="text-align:center;">Loading referrals...</td></tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4" class="center">Total Earnings</td>
                <td id="referralsTotal" class="center">0 Mg</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Mining Tab Content - UPDATED TO MATCH ORIGINAL -->
  <div id="mining-tab" class="tab-content active">
    <div class="mining-container">
      <div class="plan-title">
        <i class="fas fa-cube"></i> Miga Mining
      </div>
      <div id="ton-connect"></div>
      
      <!-- Mining stats - UPDATED TO MATCH ORIGINAL -->
      <div class="stats-bar"> 
        <div class="stat-card"> 
          <div class="stat-label">
            Total Mg
          </div> 
          <div class="stat-value">
            <span id="points-total">0</span> Mg
          </div> 
        </div> 
        <div class="stat-card"> 
          <div class="stat-label">
            Mining Speed
          </div> 
          <div class="stat-value">
            <span id="points-rate">0</span> Mg/s
          </div> 
        </div> 
        <div class="stat-card"> 
          <div class="stat-label">
            Active Plans
          </div> 
          <div class="stat-value">
            <span id="active-plans">0</span>
          </div> 
        </div> 
      </div>
      
      <div class="plan-title">
        Choose Your Mining Plan
      </div>
      <div class="circle-wrapper"> 
        <div class="plan-row"> 
          <div class="circle-container"> 
            <div class="badge bronze-badge">
              Bronze
            </div> 
            <div class="circle-card" data-days="7" data-plan="bronze"> 
              <div class="days-title">
                7 Days
              </div> 
              <div class="ton-amount">
                0.5 TON
              </div> 
              <div class="miga-points">
                0.00 mg
              </div> 
              <div class="countdown-timer" id="countdown-7d"></div> 
              <div class="speed-multiplier">
                1× Speed
              </div> 
            </div> 
          </div> 
          <div class="circle-container"> 
            <div class="badge silver-badge">
              Silver
            </div> 
            <div class="circle-card" data-days="15" data-plan="silver"> 
              <div class="days-title">
                15 Days
              </div> 
              <div class="ton-amount">
                0.75 TON
              </div> 
              <div class="miga-points">
                0.00 mg
              </div> 
              <div class="countdown-timer" id="countdown-15d"></div> 
              <div class="speed-multiplier">
                1.5× Speed
              </div> 
            </div> 
          </div> 
        </div> 
        <div class="centered-row"> 
          <div class="circle-container"> 
            <div class="badge gold-badge">
              Gold
            </div> 
            <div class="circle-card special" data-days="30" data-plan="gold"> 
              <div class="days-title">
                30 Days
              </div> 
              <div class="ton-amount">
                1 TON
              </div> 
              <div class="miga-points">
                0.00 mg
              </div> 
              <div class="countdown-timer" id="countdown-30d"></div> 
              <div class="speed-multiplier">
                2× Speed
              </div> 
            </div> 
          </div> 
        </div> 
        <div class="plan-row"> 
          <div class="circle-container"> 
            <div class="badge platinum-badge">
              Platinum
            </div> 
            <div class="circle-card" data-days="60" data-plan="platinum"> 
              <div class="days-title">
                60 Days
              </div> 
              <div class="ton-amount">
                1.5 TON
              </div> 
              <div class="miga-points">
                0.00 mg
              </div> 
              <div class="countdown-timer" id="countdown-60d"></div> 
              <div class="speed-multiplier">
                3× Speed
              </div> 
            </div> 
          </div> 
          <div class="circle-container"> 
            <div class="badge diamond-badge">
              Diamond
            </div> 
            <div class="circle-card" data-days="90" data-plan="diamond"> 
              <div class="days-title">
                90 Days
              </div> 
              <div class="ton-amount">
                2 TON
              </div> 
              <div class="miga-points">
                0.00 mg
              </div> 
              <div class="countdown-timer" id="countdown-90d"></div> 
              <div class="speed-multiplier">
                4× Speed
              </div> 
            </div> 
          </div> 
        </div> 
        <div class="centered-row"> 
          <div id="free-claim" class="circle-card free"> 
            <span class="miga-points">100</span> 
            <span class="days-title">Free Claim</span> 
          </div> 
        </div> 
      </div>
      
      <div id="wallet-message" class="wallet-message">
        <i class="fas fa-wallet"></i> Please connect your wallet first
      </div>
      <div id="plan-message" class="plan-message">
        <i class="fas fa-info-circle"></i> This plan is already active
      </div>
      <div id="alert-message" class="alert-message"></div>
    </div>
  </div>

  <!-- Tasks Tab Content -->
  <div id="tasks-tab" class="tab-content">
    <div class="tasks-container">
      <div class="task-tabs">
        <button class="task-tab active" data-tab="daily-tasks">
          <i class="fas fa-calendar-day"></i> Daily
        </button>
        <button class="task-tab" data-tab="weekly-tasks">
          <i class="fas fa-calendar-week"></i> Weekly
        </button>
        <button class="task-tab" data-tab="referral-tasks">
          <i class="fas fa-user-friends"></i> Referral
        </button>
        <button class="task-tab" data-tab="special-tasks">
          <i class="fas fa-star"></i> Special
        </button>
      </div>
      
      <!-- Daily Tasks -->
      <div id="daily-tasks" class="task-content active">
        <div class="task-category">
          <div class="category-title">Daily Tasks</div>
          <div class="task-list" id="dailyTasksList">
            Loading tasks...
          </div>
        </div>
      </div>
      
      <!-- Weekly Tasks -->
      <div id="weekly-tasks" class="task-content">
        <div class="task-category">
          <div class="category-title">Weekly Challenges</div>
          <div class="task-list" id="weeklyTasksList">
            Loading tasks...
          </div>
        </div>
      </div>
      
      <!-- Referral Tasks -->
      <div id="referral-tasks" class="task-content">
        <div class="task-category">
          <div class="category-title">Referral Missions</div>
          <div class="task-list" id="referralTasksList">
            Loading tasks...
          </div>
        </div>
      </div>
      
      <!-- Special Tasks -->
      <div id="special-tasks" class="task-content">
        <div class="task-category">
          <div class="category-title">Special Missions</div>
          <div class="task-list" id="specialTasksList">
            Loading tasks...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaders Tab Content -->
  <div id="leaders-tab" class="tab-content">
    <div class="leaders-container">
      <div class="leaderboard">
        <h2><i class="fas fa-trophy"></i> Top Miners Leaderboard</h2>
        <div id="leadersList" class="loading-indicator">
          <i class="fas fa-spinner fa-spin"></i> Loading leaderboard...
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">  
    <div class="nav-item" data-tab="home-tab">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </div>
    <div class="nav-item" data-tab="friends-tab">
      <i class="fas fa-user-friends"></i>
      <span>Friends</span>
    </div>
    <div class="nav-item active" data-tab="mining-tab">
      <i class="fas fa-digging"></i>
      <span>Mining</span>
    </div>
    <div class="nav-item" data-tab="tasks-tab">
      <i class="fas fa-tasks"></i>
      <span>Tasks</span>
    </div>
    <div class="nav-item" data-tab="leaders-tab">
      <i class="fas fa-trophy"></i>
      <span>Leaders</span>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBZZGMEtMsgd1igtipcG84tz98K9Tokb34",
      authDomain: "migamining-c6c20.firebaseapp.com",
      databaseURL: "https://migamining-c6c20-default-rtdb.firebaseio.com",
      projectId: "migamining-c6c20",
      storageBucket: "migamining-c6c20.appspot.com",
      messagingSenderId: "737327385751",
      appId: "1:737327385751:web:68eb8fd845caa7cad02dd2",
      measurementId: "G-VXPKJSHPRC"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global Variables
    let currentUser = null;
    let currentUserId = null;
    let userData = null;
    let miningChart = null;
    let tonConnectUI = null;
    let walletConnected = false;
    
    // تعريف الخطط كما في الملف الأول
    const PLANS = {
      '7': { 
        name: 'Bronze', 
        plan_name: 'bronze',
        days: 7, 
        multiplier: 1, 
        badge: 'badge-bronze',
        daily_miga: 500,
        total_miga: 3500,
        ton_amount: 0.5,
        mining_rate: 500 / (24 * 60 * 60)
      },
      '15': { 
        name: 'Silver', 
        plan_name: 'silver',
        days: 15, 
        multiplier: 1.5, 
        badge: 'badge-silver',
        daily_miga: 750,
        total_miga: 11250,
        ton_amount: 0.75,
        mining_rate: 750 / (24 * 60 * 60)
      },
      '30': { 
        name: 'Gold', 
        plan_name: 'gold',
        days: 30, 
        multiplier: 2, 
        badge: 'badge-gold',
        daily_miga: 1000,
        total_miga: 30000,
        ton_amount: 1,
        mining_rate: 1000 / (24 * 60 * 60)
      },
      '60': { 
        name: 'Platinum', 
        plan_name: 'platinum',
        days: 60, 
        multiplier: 3, 
        badge: 'badge-platinum',
        daily_miga: 1500,
        total_miga: 90000,
        ton_amount: 1.5,
        mining_rate: 1500 / (24 * 60 * 60)
      },
      '90': { 
        name: 'Diamond', 
        plan_name: 'diamond',
        days: 90, 
        multiplier: 4, 
        badge: 'badge-diamond',
        daily_miga: 2000,
        total_miga: 180000,
        ton_amount: 2,
        mining_rate: 2000 / (24 * 60 * 60)
      }
    };

    // Get URL parameter
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Tab Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function() {
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(nav => {
          nav.classList.remove('active');
        });
        
        // Add active class to clicked nav item
        this.classList.add('active');
        
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Show the selected tab
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
        
        // Initialize specific tab if needed
        if(tabId === 'home-tab') initHomePage();
        else if(tabId === 'friends-tab') initFriendsPage();
        else if(tabId === 'leaders-tab') initLeadersPage();
        else if(tabId === 'tasks-tab') initTasksPage();
      });
    });

    // Task Tab Navigation
    document.querySelectorAll('.task-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all task tabs
        document.querySelectorAll('.task-tab').forEach(t => {
          t.classList.remove('active');
        });
        
        // Add active class to clicked task tab
        this.classList.add('active');
        
        // Hide all task contents
        document.querySelectorAll('.task-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // Show the selected task content
        const contentId = this.getAttribute('data-tab');
        document.getElementById(contentId).classList.add('active');
      });
    });

    // Initialize App
    async function initApp() {
      try {
        // Get Telegram user data
        const tg = window.Telegram?.WebApp;
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          currentUser = tg.initDataUnsafe.user;
          currentUserId = currentUser.id.toString();
          
          // Initialize user in database
          await initUserInDatabase();
          
          // Load user data
          await loadUserData();
          
          // Initialize TON Connect for mining page
          initMiningPage();
          
          // Initialize other pages
          initHomePage();
          initFriendsPage();
          initTasksPage();
          
          // Start real-time updates
          startRealtimeUpdates();
        } else {
          // Fallback for non-Telegram users
          currentUserId = "guest_" + Date.now();
          currentUser = {
            first_name: "Guest",
            username: "guest"
          };
          
          // Initialize mining page anyway
          initMiningPage();
        }
      } catch (error) {
        console.error("Error initializing app:", error);
      }
    }

    // Initialize user in database
    async function initUserInDatabase() {
      const userRef = database.ref('users/' + currentUserId);
      const snapshot = await userRef.once('value');
      
      if (!snapshot.exists()) {
        // Check for referral
        const referrerId = getQueryParam('start');
        
        // Create new user
        const userData = {
          telegram_id: currentUserId,
          username: currentUser.username || "no_username",
          first_name: currentUser.first_name || "User",
          last_name: currentUser.last_name || "",
          join_date: new Date().toISOString(),
          referrer: referrerId || null,
          referrals: [],
          total_miga: 0,
          daily_miga: 0,
          weekly_miga: 0,
          monthly_miga: 0,
          active_plans: [],
          completed_tasks: {},
          daily_bonus_claimed: false,
          last_bonus_claim: null,
          total_referral_earnings: 0,
          mining_speed: 0,
          status: 'inactive',
          rank: 0
        };
        
        await userRef.set(userData);
        
        // Add to referrals if referrer exists
        if (referrerId && referrerId !== currentUserId) {
          await addReferral(referrerId, currentUserId);
        }
      }
    }

    // Load user data
    async function loadUserData() {
      const userRef = database.ref('users/' + currentUserId);
      userRef.on('value', (snapshot) => {
        userData = snapshot.val();
        if (userData) {
          updateUIWithUserData();
          updateMiningDisplay();
        }
      });
    }

    // Update UI with user data
    function updateUIWithUserData() {
      if (!userData) return;
      
      // Home page
      document.getElementById('userName').textContent = userData.first_name;
      document.getElementById('userUsername').textContent = "@" + userData.username;
      document.getElementById('userTotalMiga').textContent = userData.total_miga?.toFixed(6) || '0';
      
      // Update mining stats
      document.getElementById('points-total').textContent = userData.total_miga?.toFixed(6) || '0';
      document.getElementById('active-plans').textContent = userData.active_plans?.length || '0';
      
      // Calculate mining speed
      let totalDailyMiga = 0;
      if (userData.active_plans && Array.isArray(userData.active_plans)) {
        userData.active_plans.forEach(plan => {
          if (plan.status === 'active') {
            const planInfo = PLANS[plan.days];
            if (planInfo) {
              totalDailyMiga += planInfo.daily_miga;
            }
          }
        });
      }
      
      const miningSpeed = totalDailyMiga / (24 * 60 * 60); // Convert to Mg/s
      document.getElementById('points-rate').textContent = miningSpeed.toFixed(6);
    }

    // Update mining display with active plans
    function updateMiningDisplay() {
      if (!userData || !userData.active_plans) return;
      
      // Reset all circle cards
      document.querySelectorAll('.circle-card').forEach(card => {
        card.classList.remove('active-pulse');
        const badge = card.parentElement.querySelector('.badge');
        if (badge) badge.classList.remove('badge-pulse');
        
        const cd = card.querySelector(".countdown-timer");
        const mp = card.querySelector(".miga-points");
        
        if (cd) {
          cd.style.display = "none";
          cd.textContent = "";
        }
        if (mp) mp.textContent = "0.00 mg";
        
        // Clear any existing timer
        if (card._timer) clearInterval(card._timer);
      });
      
      // Update each active plan
      userData.active_plans.forEach(plan => {
        if (plan.status === 'active') {
          const circleCard = document.querySelector(`.circle-card[data-days="${plan.days}"]`);
          if (!circleCard) return;
          
          startPlanTimer(plan, circleCard);
        }
      });
      
      // Update free claim button
      updateFreeClaimButton();
    }

    // Start timer for a plan
    function startPlanTimer(plan, circleCard) {
      circleCard.classList.add("active-pulse");
      const badge = circleCard.parentElement.querySelector('.badge');
      if (badge) badge.classList.add("badge-pulse");
      
      const cd = circleCard.querySelector(".countdown-timer");
      const mp = circleCard.querySelector(".miga-points");
      
      if (cd) cd.style.display = "block";
      if (mp) mp.textContent = `${plan.mined_so_far?.toFixed(6) || '0.00'} mg`;
      
      // Clear any existing timer
      if (circleCard._timer) clearInterval(circleCard._timer);
      
      circleCard._timer = setInterval(() => {
        if (!plan.end_time) return;
        
        const endTime = new Date(plan.end_time);
        const now = new Date();
        const timeRemaining = endTime - now;
        
        if (timeRemaining <= 0) {
          clearInterval(circleCard._timer);
          circleCard.classList.remove("active-pulse");
          if (badge) badge.classList.remove("badge-pulse");
          if (cd) {
            cd.textContent = "Completed";
            setTimeout(() => {
              cd.style.display = "none";
            }, 5000);
          }
          return;
        }
        
        // Update countdown
        if (cd) {
          const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
          
          cd.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        
        // Update mined amount from Firebase data
        if (mp) mp.textContent = `${plan.mined_so_far?.toFixed(6) || '0.00'} mg`;
      }, 1000);
    }

    // Update free claim button
    function updateFreeClaimButton() {
      const freeBtn = document.getElementById("free-claim");
      if (!freeBtn || !userData) return;
      
      const now = new Date();
      const lastClaim = userData.last_bonus_claim ? new Date(userData.last_bonus_claim) : null;
      const canClaim = !lastClaim || (now - lastClaim) >= 24 * 60 * 60 * 1000;
      
      if (userData.active_plans?.length > 0 && canClaim && !userData.daily_bonus_claimed) {
        freeBtn.classList.add("active");
        freeBtn.classList.remove("disabled");
        freeBtn.querySelector(".miga-points").textContent = "100";
        freeBtn.querySelector(".days-title").textContent = "Free Claim";
        
        // Add click event
        freeBtn.onclick = () => claimDailyBonus();
      } else {
        freeBtn.classList.remove("active");
        freeBtn.classList.add("disabled");
        
        if (!canClaim && lastClaim) {
          const nextClaim = new Date(lastClaim.getTime() + 24 * 60 * 60 * 1000);
          const timeLeft = nextClaim - now;
          const hours = Math.floor(timeLeft / (1000 * 60 * 60));
          const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
          
          freeBtn.querySelector(".miga-points").textContent = `${hours}h ${minutes}m`;
          freeBtn.querySelector(".days-title").textContent = "Next Bonus";
        } else {
          freeBtn.querySelector(".miga-points").textContent = "Bonus";
          freeBtn.querySelector(".days-title").textContent = "Available";
        }
        
        freeBtn.onclick = null;
      }
    }

    // Claim daily bonus
    async function claimDailyBonus() {
      if (!currentUserId || !userData) return;
      
      try {
        await database.ref('users/' + currentUserId).update({
          daily_bonus_claimed: true,
          last_bonus_claim: new Date().toISOString(),
          total_miga: (userData.total_miga || 0) + 100,
          daily_miga: (userData.daily_miga || 0) + 100,
          weekly_miga: (userData.weekly_miga || 0) + 100,
          monthly_miga: (userData.monthly_miga || 0) + 100
        });
        
        showAlert("Daily bonus claimed! +100 Mg", "success");
        updateFreeClaimButton();
        
      } catch (error) {
        console.error("Error claiming daily bonus:", error);
        showAlert("Error claiming bonus", "error");
      }
    }

    // Add referral
    async function addReferral(referrerId, newUserId) {
      try {
        const referrerRef = database.ref('users/' + referrerId);
        const snapshot = await referrerRef.once('value');
        
        if (snapshot.exists()) {
          const referrerData = snapshot.val();
          const referrals = referrerData.referrals || [];
          
          if (!referrals.includes(newUserId)) {
            referrals.push(newUserId);
            
            // Update referrer data
            await referrerRef.update({
              referrals: referrals,
              total_referral_earnings: (referrerData.total_referral_earnings || 0) + 100,
              total_miga: (referrerData.total_miga || 0) + 100,
              daily_miga: (referrerData.daily_miga || 0) + 100,
              weekly_miga: (referrerData.weekly_miga || 0) + 100,
              monthly_miga: (referrerData.monthly_miga || 0) + 100
            });
            
            // Update global referral count
            const globalRef = database.ref('global/stats');
            const globalSnapshot = await globalRef.once('value');
            const globalData = globalSnapshot.val() || { total_referrals: 0 };
            
            await globalRef.update({
              total_referrals: (globalData.total_referrals || 0) + 1
            });
          }
        }
      } catch (error) {
        console.error("Error adding referral:", error);
      }
    }

    // MINING PAGE FUNCTIONS
    function initMiningPage() {
      // Initialize TON Connect
      tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: "https://ibrahimbosra.github.io/Pay/tonconnect-manifest.json",
        buttonRootId: "ton-connect",
        language: "en"
      });
      
      // Update wallet status
      tonConnectUI.onStatusChange(info => {
        walletConnected = !!(info && info.account);
        if (!walletConnected) {
          document.getElementById("wallet-message").style.display = "block";
        } else {
          document.getElementById("wallet-message").style.display = "none";
        }
      });
      
      // Add click events to plan cards
      document.querySelectorAll('.circle-card[data-days]').forEach(card => {
        card.addEventListener('click', function() {
          const days = parseInt(this.getAttribute('data-days'));
          const plan = PLANS[days];
          if (plan) {
            handlePlanClick(plan.ton_amount, days, plan.multiplier, this);
          }
        });
      });
    }

    // Handle plan purchase
    async function handlePlanClick(priceTon, days, multiplier, circleCard) {
      if (!walletConnected) {
        if (tonConnectUI) {
          tonConnectUI.openModal();
        }
        document.getElementById("wallet-message").style.display = "block";
        setTimeout(() => {
          document.getElementById("wallet-message").style.display = "none";
        }, 5000);
        return;
      }
      
      // Check if plan is already active
      if (userData && userData.active_plans) {
        const isAlreadyActive = userData.active_plans.some(plan => 
          plan.days === days && plan.status === 'active'
        );
        
        if (isAlreadyActive) {
          document.getElementById("plan-message").innerHTML = 
            `<i class="fas fa-info-circle"></i> This plan is already active!`;
          document.getElementById("plan-message").style.display = "block";
          setTimeout(() => {
            document.getElementById("plan-message").style.display = "none";
          }, 3000);
          return;
        }
      }
      
      const planInfo = PLANS[days];
      if (!planInfo) return;
      
      // Create plan data
      const planData = {
        plan_name: planInfo.plan_name,
        days: planInfo.days,
        ton_amount: planInfo.ton_amount,
        multiplier: planInfo.multiplier,
        daily_miga: planInfo.daily_miga,
        start_time: new Date().toISOString(),
        end_time: new Date(Date.now() + (planInfo.days * 24 * 60 * 60 * 1000)).toISOString(),
        last_update: new Date().toISOString(),
        mined_so_far: 0,
        status: "active",
        total_miga: planInfo.total_miga
      };
      
      try {
        // Add plan to user's active plans
        const userRef = database.ref('users/' + currentUserId);
        const activePlans = userData?.active_plans ? [...userData.active_plans] : [];
        activePlans.push(planData);
        
        await userRef.update({
          active_plans: activePlans,
          status: 'active',
          updated_at: new Date().toISOString()
        });
        
        // Show success message
        showAlert(`${planInfo.name} plan activated!`, 'success');
        
        // Update global stats
        const globalRef = database.ref('global/stats');
        globalRef.transaction((stats) => {
          if (stats) {
            stats.total_plans_purchased = (stats.total_plans_purchased || 0) + 1;
            stats.active_miners = (stats.active_miners || 0) + 1;
          }
          return stats;
        });
        
        // Start timer for the plan
        startPlanTimer(planData, circleCard);
        
        // Redirect to TON payment
        window.location.href =
          `ton://transfer/UQADR_wO9cnAQYUGErMlhP57EFWK78aubu20uxUw-n63Tuo4?amount=${
            Math.floor(priceTon * 1e9)
          }&text=Miga%20Mining`;
          
      } catch (error) {
        console.error("Error activating plan:", error);
        showAlert("Error activating plan", "error");
      }
    }

    // Home Page
    function initHomePage() {
      updateGlobalStats();
      initMiningChart();
    }

    // Update global stats
    async function updateGlobalStats() {
      try {
        const statsRef = database.ref('global/stats');
        statsRef.on('value', (snapshot) => {
          const stats = snapshot.val() || {};
          
          document.getElementById('totalUsers').textContent = stats.total_users?.toLocaleString() || '0';
          document.getElementById('totalMigaMined').textContent = 
            stats.total_miga_mined ? Math.floor(stats.total_miga_mined).toLocaleString() : '0';
          document.getElementById('activeMiners').textContent = stats.active_miners?.toLocaleString() || '0';
          
          // Calculate user rank
          if (userData && userData.total_miga) {
            database.ref('users').once('value').then((usersSnapshot) => {
              const users = [];
              usersSnapshot.forEach((childSnapshot) => {
                const user = childSnapshot.val();
                if (user.total_miga) {
                  users.push({
                    id: childSnapshot.key,
                    total_miga: user.total_miga
                  });
                }
              });
              
              users.sort((a, b) => b.total_miga - a.total_miga);
              const rank = users.findIndex(u => u.id === currentUserId) + 1;
              document.getElementById('userRank').textContent = rank > 0 ? '#' + rank : 'Unranked';
              
              // Update rank in database
              database.ref('users/' + currentUserId).update({
                rank: rank
              });
            });
          }
        });
      } catch (error) {
        console.error("Error updating global stats:", error);
      }
    }

    // Initialize mining chart
    function initMiningChart() {
      const ctx = document.getElementById('miningChart').getContext('2d');
      
      // Fetch mining history
      database.ref('global/mining_history').limitToLast(7).once('value')
        .then((snapshot) => {
          const history = snapshot.val() || {};
          const labels = [];
          const data = [];
          
          Object.keys(history).forEach(date => {
            labels.push(date);
            data.push(history[date]);
          });
          
          if (miningChart) {
            miningChart.destroy();
          }
          
          miningChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Daily Miga Mined',
                data: data,
                borderColor: '#b64fc8',
                backgroundColor: 'rgba(182, 79, 200, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 3,
                pointBackgroundColor: '#b64fc8',
                borderWidth: 2,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  grid: { color: 'rgba(0, 51, 102, 0.2)' },
                  ticks: { color: '#aee9f7' }
                },
                y: {
                  grid: { color: 'rgba(0, 51, 102, 0.2)' },
                  ticks: { color: '#aee9f7' }
                }
              },
              plugins: {
                legend: { 
                  display: true,
                  labels: { color: '#aee9f7' }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error("Error loading mining chart:", error);
        });
    }

    // Friends Page
    function initFriendsPage() {
      updateReferralData();
      
      // Copy to clipboard
      const inviteLink = document.getElementById('inviteLink');
      const copyMsg = document.getElementById('copyMsg');
      
      inviteLink.addEventListener('click', () => {
        const link = inviteLink.textContent.trim();
        if (link && link !== "Loading invite link...") {
          navigator.clipboard.writeText(link).then(() => {
            copyMsg.classList.add('visible');
            setTimeout(() => {
              copyMsg.classList.remove('visible');
            }, 2000);
          }).catch(err => {
            console.error('Copy failed:', err);
          });
        }
      });
    }

    // Update referral data
    async function updateReferralData() {
      if (!currentUserId) return;
      
      const userRef = database.ref('users/' + currentUserId);
      userRef.on('value', (snapshot) => {
        const user = snapshot.val();
        if (!user) return;
        
        // Update invite link
        const inviteLink = `https://t.me/Migamining_bot?start=${currentUserId}`;
        document.getElementById('inviteLink').textContent = inviteLink;
        
        // Update friends count and earnings
        const referrals = user.referrals || [];
        const earnings = user.total_referral_earnings || 0;
        
        document.getElementById('friendsCount').innerHTML = 
          `Friends invited: <strong>${referrals.length}</strong> | Earned: <strong>${earnings}</strong> Mg`;
        
        // Update referrals table
        const referralsBody = document.getElementById('referralsBody');
        const referralsTotal = document.getElementById('referralsTotal');
        
        if (referrals.length === 0) {
          referralsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No friends invited yet.</td></tr>';
          referralsTotal.textContent = "0 Mg";
          return;
        }
        
        referralsBody.innerHTML = '';
        let totalEarnings = 0;
        
        referrals.forEach(async (refId, index) => {
          try {
            const refSnapshot = await database.ref('users/' + refId).once('value');
            const refData = refSnapshot.val();
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="center">${index + 1}</td>
              <td>${refData?.username || 'Unknown'} (ID: ${refId.slice(0, 6)}...)</td>
              <td class="center">${refData?.join_date ? new Date(refData.join_date).toLocaleDateString() : 'Unknown'}</td>
              <td class="center">${refData?.active_plans?.length > 0 ? 'Active' : 'Inactive'}</td>
              <td class="center">100 Mg</td>
            `;
            referralsBody.appendChild(tr);
            
            totalEarnings += 100;
            referralsTotal.textContent = totalEarnings + " Mg";
          } catch (error) {
            console.error("Error loading referral data:", error);
          }
        });
      });
    }

    // Tasks Page
    function initTasksPage() {
      loadTasks();
    }

    // Load tasks from database
    async function loadTasks() {
      try {
        const tasksRef = database.ref('tasks');
        const snapshot = await tasksRef.once('value');
        const tasks = snapshot.val();
        
        if (!tasks) {
          // Create default tasks if none exist
          const defaultTasks = {
            daily_1: {
              name: "Daily Login",
              description: "Log in to claim your daily reward",
              category: "daily",
              reward: 50,
              max_progress: 1
            },
            daily_2: {
              name: "Mine for 1 hour",
              description: "Keep mining for at least 1 hour",
              category: "daily",
              reward: 100,
              max_progress: 3600
            },
            weekly_1: {
              name: "Weekly Mining",
              description: "Mine for 7 days in a row",
              category: "weekly",
              reward: 500,
              max_progress: 7
            },
            referral_1: {
              name: "Invite 1 Friend",
              description: "Invite your first friend to join",
              category: "referral",
              reward: 200,
              max_progress: 1
            }
          };
          
          await tasksRef.set(defaultTasks);
          tasks = defaultTasks;
        }
        
        // Filter tasks by category
        const dailyTasks = Object.entries(tasks).filter(([_, task]) => task.category === 'daily');
        const weeklyTasks = Object.entries(tasks).filter(([_, task]) => task.category === 'weekly');
        const referralTasks = Object.entries(tasks).filter(([_, task]) => task.category === 'referral');
        const specialTasks = Object.entries(tasks).filter(([_, task]) => task.category === 'special');
        
        // Render tasks
        renderTaskList('dailyTasksList', dailyTasks);
        renderTaskList('weeklyTasksList', weeklyTasks);
        renderTaskList('referralTasksList', referralTasks);
        renderTaskList('specialTasksList', specialTasks);
        
      } catch (error) {
        console.error("Error loading tasks:", error);
      }
    }

    // Render task list
    function renderTaskList(elementId, tasks) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      if (tasks.length === 0) {
        element.innerHTML = '<div style="text-align:center; padding:20px; color:#aee9f7;">No tasks available</div>';
        return;
      }
      
      let html = '';
      tasks.forEach(([taskId, task]) => {
        const isCompleted = userData?.completed_tasks?.[taskId] || false;
        const progress = task.progress || 0;
        const maxProgress = task.max_progress || 1;
        const progressPercent = Math.min((progress / maxProgress) * 100, 100);
        
        html += `
          <div class="task-item">
            <div class="task-info">
              <div class="task-name">${task.name}</div>
              <div class="task-description">${task.description}</div>
              ${task.max_progress > 1 ? `
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div style="font-size:11px; color:#aee9f7; margin-top:2px;">
                  ${progress}/${maxProgress}
                </div>
              ` : ''}
            </div>
            <div>
              <div class="task-reward">+${task.reward} Miga</div>
              <button class="task-button" 
                ${isCompleted ? 'disabled' : ''}
                onclick="claimTaskReward('${taskId}', ${task.reward})">
                ${isCompleted ? 'Claimed' : 'Claim'}
              </button>
            </div>
          </div>
        `;
      });
      
      element.innerHTML = html;
    }

    // Claim task reward
    async function claimTaskReward(taskId, reward) {
      try {
        // Update user data
        const completedTasks = userData.completed_tasks || {};
        completedTasks[taskId] = true;
        
        await database.ref('users/' + currentUserId).update({
          completed_tasks: completedTasks,
          total_miga: (userData.total_miga || 0) + reward,
          daily_miga: (userData.daily_miga || 0) + reward,
          weekly_miga: (userData.weekly_miga || 0) + reward,
          monthly_miga: (userData.monthly_miga || 0) + reward
        });
        
        // Show success message
        showAlert(`Task completed! +${reward} Mg earned`, 'success');
        
        // Reload tasks
        initTasksPage();
        
      } catch (error) {
        console.error("Error claiming task reward:", error);
        showAlert("Error claiming reward. Please try again.", "error");
      }
    }

    // Leaders Page
    function initLeadersPage() {
      loadLeaderboard();
    }

    // Load leaderboard from database
    async function loadLeaderboard() {
      try {
        const usersRef = database.ref('users');
        const snapshot = await usersRef.once('value');
        const users = [];
        
        snapshot.forEach((childSnapshot) => {
          const user = childSnapshot.val();
          if (user.total_miga > 0) {
            users.push({
              id: childSnapshot.key,
              name: user.first_name || 'User',
              username: user.username,
              total_miga: user.total_miga || 0,
              rank: user.rank || 0
            });
          }
        });
        
        // Sort by total Miga
        users.sort((a, b) => b.total_miga - a.total_miga);
        
        // Update ranks
        users.forEach((user, index) => {
          user.rank = index + 1;
        });
        
        // Display leaderboard
        const leadersList = document.getElementById('leadersList');
        leadersList.innerHTML = '';
        
        users.slice(0, 20).forEach((user, index) => {
          const isCurrentUser = user.id === currentUserId;
          
          const div = document.createElement('div');
          div.className = 'leader';
          if (isCurrentUser) {
            div.style.background = 'rgba(182, 79, 200, 0.3)';
            div.style.border = '1px solid rgba(182, 79, 200, 0.5)';
          }
          
          div.innerHTML = `
            <div class="rank">#${user.rank}</div>
            <div class="name">
              ${user.name} 
              ${isCurrentUser ? '<span style="color:var(--accent);">(You)</span>' : ''}
              <br>
              <small style="color:#aee9f7; font-size:11px;">@${user.username}</small>
            </div>
            <div class="amount">${Math.floor(user.total_miga).toLocaleString()} Mg</div>
          `;
          
          leadersList.appendChild(div);
        });
        
        if (users.length === 0) {
          leadersList.innerHTML = '<div style="text-align:center; padding:20px; color:#aee9f7;">No miners yet</div>';
        }
        
      } catch (error) {
        console.error("Error loading leaderboard:", error);
        document.getElementById('leadersList').innerHTML = 
          '<div style="text-align:center; padding:20px; color:var(--danger);">Error loading leaderboard</div>';
      }
    }

    // Start real-time updates
    function startRealtimeUpdates() {
      // Update user data every 30 seconds
      setInterval(async () => {
        if (currentUserId) {
          const snapshot = await database.ref('users/' + currentUserId).once('value');
          userData = snapshot.val();
          if (userData) {
            updateMiningDisplay();
          }
        }
      }, 30000);
    }

    // Show alert message
    function showAlert(message, type = 'info') {
      const alertMsg = document.getElementById('alert-message');
      
      alertMsg.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
      `;
      
      alertMsg.style.color = type === 'success' ? 'var(--success)' : 
                           type === 'error' ? 'var(--danger)' : 'var(--accent)';
      alertMsg.style.display = 'block';
      
      setTimeout(() => {
        alertMsg.style.display = 'none';
      }, 5000);
    }

    // Initialize on DOM loaded
    document.addEventListener("DOMContentLoaded", function() {
      initApp();
    });
  </script>
</body>
</html>
